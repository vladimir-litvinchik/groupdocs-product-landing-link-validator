name: Landing Page Links Validation

on:
  schedule:
    - cron: "0 6 * * *" # daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WRITE_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run validation
        id: validate
        run: |
          python validate_landing_page_links.py
        continue-on-error: true

      - name: Check validation results
        id: check_results
        run: |
          ERROR_COUNT=0
          if [ -f validation_report.md ]; then
            # Count errors (lines with ❌) and remove all whitespace/newlines
            ERROR_COUNT=$(grep -c "❌" validation_report.md 2>/dev/null | tr -d '\n\r\t ' || echo "0")
            # Ensure we have a valid number, default to 0 if empty
            if [ -z "$ERROR_COUNT" ]; then
              ERROR_COUNT=0
            fi
            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "has_errors=true" >> $GITHUB_OUTPUT
            else
              echo "has_errors=false" >> $GITHUB_OUTPUT
            fi
          else
            ERROR_COUNT=1
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "error_count=1" >> $GITHUB_OUTPUT
          fi
          
          # Also check if validation script failed
          if [ "${{ steps.validate.outcome }}" == "failure" ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            if [ "$ERROR_COUNT" -eq 0 ]; then
              ERROR_COUNT=1
              echo "error_count=1" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Commit changes
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add validation_report.md product_links.json || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update landing page links validation report"
            git push origin HEAD
          fi

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: |
            validation_report.md
            product_links.json

      - name: Create or update issue
        if: steps.check_results.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('validation_report.md', 'utf8');
            
            // Find existing open issue with same title
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'landing-page-validation'
            });
            
            const today = new Date().toISOString().slice(0, 10);
            const title = `Landing Page Validation Failed - ${today}`;
            
            const existingIssue = issues.find(issue => issue.title.includes('Landing Page Validation Failed'));
            
            const errorCount = '${{ steps.check_results.outputs.error_count }}';
            const body = `## Landing Page Validation Report\n\n` +
              `**Generated:** ${new Date().toISOString()}\n\n` +
              `**Errors Found:** ${errorCount}\n\n` +
              `---\n\n` +
              report +
              `\n\n---\n\n` +
              `*This issue was automatically created by the Landing Page Validation workflow.*`;
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              core.info(`Updated issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['landing-page-validation', 'automation']
              });
              core.info(`Created issue #${issue.number}`);
            }

